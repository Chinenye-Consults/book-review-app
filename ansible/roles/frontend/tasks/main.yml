- name: Clone frontend repository
  git:
    repo: "{{ frontend_repo_url }}"
    dest: /opt/frontend
    version: main

- name: Set ownership to chinenye for frontend app
  file:
    path: /opt/frontend
    owner: chinenye
    group: chinenye
    recurse: yes

- name: Install frontend dependencies
  npm:
    path: /opt/frontend/frontend
    state: present

- name: Create frontend environment file
  copy:
    dest: /opt/frontend/frontend/.env
    content: |
      NEXT_PUBLIC_API_URL={{ backend_api_url }}
      
- name: Remove old build directory if exists
  file:
    path: /opt/frontend/frontend/.next
    state: absent

- name: Build frontend for production
  shell: |
    cd /opt/frontend/frontend
    npm run build
  args:
    executable: /bin/bash

- name: Stop and delete any existing PM2 frontend process
  shell: |
    pm2 delete book-review-frontend || true
    pm2 kill
  args:
    executable: /bin/bash
    
- name: Remove old PM2 dump file (erase ghost memory)
  file:
    path: /home/chinenye/.pm2/dump.pm2
    state: absent

- name: Remove old PM2 logs (optional cleanup)
  file:
    path: /home/chinenye/.pm2/logs
    state: absent
    recurse: yes
    when: ansible_facts['filesystem']['/home/chinenye/.pm2/logs'] is defined

- name: Recreate PM2 logs directory
  file:
    path: /home/chinenye/.pm2/logs
    state: directory
    owner: chinenye
    group: chinenye
    mode: '0775'
    
- name: Ensure port 3000 is free
  shell: |
    if sudo ss -tulpn | grep -q ":3000"; then
      sudo fuser -k 3000/tcp
    fi
  args:
    executable: /bin/bash
    
- name: Start frontend app using PM2 (production mode)
  shell: |
    cd /opt/frontend/frontend
    pm2 start npm --name book-review-frontend -- start
  args:
    executable: /bin/bash

- name: Only save PM2 process if it started successfully
  shell: |
    if pm2 describe book-review-frontend | grep -q 'online'; then
      pm2 save
    fi
  args:
    executable: /bin/bash
