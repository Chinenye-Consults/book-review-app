- name: Clone frontend repository
  git:
    repo: "{{ frontend_repo_url }}"
    dest: /opt/frontend
    version: main

- name: Set ownership to chinenye for frontend app
  file:
    path: /opt/frontend
    owner: chinenye
    group: chinenye
    recurse: yes

- name: Install frontend dependencies
  npm:
    path: /opt/frontend/frontend
    state: present

- name: Create frontend environment file
  copy:
    dest: /opt/frontend/frontend/.env
    content: |
      NEXT_PUBLIC_API_URL={{ backend_api_url }}
      
- name: Remove old build directory if exists
  file:
    path: /opt/frontend/frontend/.next
    state: absent

- name: Build frontend for production
  shell: |
    cd /opt/frontend/frontend
    npm run build
  args:
    executable: /bin/bash

- name: Stop any existing PM2 frontend process
  shell: |
    pm2 delete book-review-frontend || true
  args:
    executable: /bin/bash
    
- name: Start frontend app using PM2 (production mode)
  shell: |
    cd /opt/frontend/frontend
    pm2 start npm --name book-review-frontend -- start
  args:
    executable: /bin/bash

- name: Save PM2 process list
  shell: pm2 save
